# 一、基本架构
大体来说，MySQL 可以分为 Server 层 和 存储引擎层两部分。  

Server 层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖 MySQL 的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。  

存储引擎层负责数据的存储和提取。其架构模式是插件式的，支持 InnoDB、MyISAM、Memory 等多个存储引擎。现在最常用的存储引擎是 InnoDB，它从 MySQL 5.5.5 版本开始成为了默认存储引擎。

**具体架构如下:**  

![](./static/mysql.png "")

## 1.连接器
第一步客户端会先连接数据库，连接器负责与客户端连接，    

`mysql -h$ip -P$port -u$user -p`    

并且用户所拥有的权限也在连接器中判断，表明如果一个用A户登录之后，另一个客户端使用root把A用户的权限修改了，但不立即生效，A用户重新登录之后才会有修改后的权限。   

**长连接**  
长连接是指连接成功后，如果客户端持续有请求，则一直使用同一个连接。  
**短连接**  
短连接则是指每次执行完很少的几次查询就断开连接，下次查询再重新建立一个。    

建立连接的过程通常是比较复杂的，所以我建议你在使用中要尽量减少建立连接的动作，也就是尽量使用长连接。

但是全部使用长连接后，你可能会发现，有些时候 MySQL 占用内存涨得特别快，这是因为 MySQL 在执行过程中临时使用的内存是管理在连接对象里面的。这些资源会在连接断开的时候才释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现象看就是 MySQL 异常重启了。  

怎么解决这个问题呢？    

你可以考虑以下两种方案。
- 定期断开长连接。使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。
- 如果你用的是 MySQL 5.7 或更新版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection 来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。    

## 2.查询缓存
每次的数据库操作都会以**key-value**的形式存储在内存中，key是sql语句，vaule是执行结果。进行查时会先查找缓存中是否存在相同的key，如果命中直接返回结果，若没有则继续往下执行。有个弊端是，当表中的数据更新时，则删除全部与此表相关的内容。在mysql8.0版本中彻底去掉了该功能。

## 3.分析器
分析每条sql语句关键字。

## 4.优化器
优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。

## 5.执行器
首先验证该用户是否有查询或更新此表的权限，

